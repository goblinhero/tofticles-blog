<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
    
      
        Migrating Application to K8S |
      Magnus Toftdal

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.124.0"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Magnus Toftdal" />
  <meta
    name="description"
    content="There are no silver bullets! 
Here, have mine
"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.772eefee9824c26da5d3828c2507ea318c8e7a37b0b1d18cd4f224edc2755fea.css"
      integrity="sha256-dy7v7pgkwm2l04KMJQfqMYyOejewsdGM1PIk7cJ1X&#43;o="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
    
    
    <link
      rel="stylesheet"
      href="/css/custom.min.910eb93950d8bbbc989d4d1c78356baa8a2f649e4956e003b91741fe931354b9.css"
      integrity="sha256-kQ65OVDYu7yYnU0ceDVrqoovZJ5JVuADuRdB/pMTVLk="
      crossorigin="anonymous"
      media="screen"
    />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="http://localhost:1313/2024/migrating-application-to-k8s/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js"
      integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc="
      crossorigin="anonymous"
    ></script>
  

  


  
  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Migrating Application to K8S"/>
<meta name="twitter:description" content="Dockerize all the things!"/>



  
  <meta property="og:title" content="Migrating Application to K8S" />
<meta property="og:description" content="Dockerize all the things!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2024/migrating-application-to-k8s/" /><meta property="article:section" content="2024" />
<meta property="article:published_time" content="2024-03-13T13:40:58+01:00" />
<meta property="article:modified_time" content="2024-03-13T13:40:58+01:00" /><meta property="og:site_name" content="Adventures of Tofticles" />



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "2024",
        "name": "Migrating Application to K8S",
        "headline": "Migrating Application to K8S",
        "alternativeHeadline": "",
        "description": "
      
        Dockerize all the things!


      


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/2024\/migrating-application-to-k8s\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Magnus Toftdal"
        },
        "creator" : {
            "@type": "Person",
            "name": "Magnus Toftdal"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Magnus Toftdal"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Magnus Toftdal"
        },
        "copyrightYear" : "2024",
        "dateCreated": "2024-03-13T13:40:58.00Z",
        "datePublished": "2024-03-13T13:40:58.00Z",
        "dateModified": "2024-03-13T13:40:58.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Magnus Toftdal",
            "url": "http://localhost:1313/",
            "logo": {
                "@type": "ImageObject",
                "url": "http:\/\/localhost:1313\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "http:\/\/localhost:1313\/2024\/migrating-application-to-k8s\/",
        "wordCount" : "588",
        "genre" : [ ],
        "keywords" : [ ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar wrapper__sidebar--hidden"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/tofticles.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Adventures of Tofticles</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>There are no silver bullets! <br />Here, have mine<br /></p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://helvede.net/@tofticles"
            target="_blank"
            rel="noopener me"
            aria-label="mastodon"
            title="mastodon"
          >
            <i class="fa-brands fa-mastodon fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/magnus-toftdal/"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="mailto:toftdal@hey.com"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Magnus Toftdal
        2024
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main wrapper__main--fullscreen"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/index.xml"
              
              title=""
              >RSS</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/2024"
              
              title=""
              >2024</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/2023"
              
              title=""
              >2023</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>Migrating Application to K8S</h1>
      <p>Now that I have the K3S cluster up and running, the time has come to adjust the Anex project to be deployable to it. You can find the code for this change <a href="https://github.com/goblinhero/Anex/pull/33">here</a>.</p>
<h2 id="docker">Docker</h2>
<p>I&rsquo;m not going to explain the idea behind Docker - plenty of information about that online, already. Instead, I&rsquo;m going to focus on the dockerfile that I ended up with after much tinkering - there are a lot of different ways to set it all up, and this is only one viable approach.</p>
<h4 id="the-entire-dockerfile">The entire dockerfile</h4>
<pre tabindex="0"><code>FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
USER $APP_UID
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

COPY [&#34;Anex.Api/Anex.Api.csproj&#34;, &#34;Anex.Api/&#34;]
RUN dotnet restore &#34;Anex.Api/Anex.Api.csproj&#34;

COPY [&#34;Anex.Domain.Tests/Anex.Domain.Tests.csproj&#34;, &#34;Anex.Domain.Tests/&#34;]
RUN dotnet restore &#34;Anex.Domain.Tests/Anex.Domain.Tests.csproj&#34;

COPY . .

WORKDIR &#34;/src/Anex.Domain.Tests&#34;
RUN dotnet test &#34;Anex.Domain.Tests.csproj&#34;

WORKDIR &#34;/src/Anex.Api&#34;
RUN dotnet build &#34;Anex.Api.csproj&#34; -c $BUILD_CONFIGURATION -o /app/build

FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish &#34;Anex.Api.csproj&#34; -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT [&#34;dotnet&#34;, &#34;Anex.Api.dll&#34;]
</code></pre><p>Quite a bit going on here, I&rsquo;ll try to explain my thoughts for each section, below.</p>
<h4 id="why-two-dotnet-images">Why two dotnet images?</h4>
<pre tabindex="0"><code>FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
USER $APP_UID
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
ARG BUILD_CONFIGURATION=Release
</code></pre><p>So - there are basically two phases to creating the final image: Building the sourcecode into binaries and running these binaries in another image. Each has it&rsquo;s own prereqs and constraints. The build phase only happens once (at some point, in the CI/CD pipeline) while the final image will be used whenever a new container is spun up. While we are building the final image, we need access to the dotnet SDK (the build/sdk image above) - however, this is not needed once the application has been built and packaged. At that point we only need the base/aspnet image with the dotnet Core runtime. The result is that the docker image that will be used to have the app running in K3S will be much smaller and leaner.</p>
<h4 id="why-three-copy-commands">Why three COPY commands?</h4>
<pre tabindex="0"><code>WORKDIR /src

COPY [&#34;Anex.Api/Anex.Api.csproj&#34;, &#34;Anex.Api/&#34;]
RUN dotnet restore &#34;Anex.Api/Anex.Api.csproj&#34;

COPY [&#34;Anex.Domain.Tests/Anex.Domain.Tests.csproj&#34;, &#34;Anex.Domain.Tests/&#34;]
RUN dotnet restore &#34;Anex.Domain.Tests/Anex.Domain.Tests.csproj&#34;

COPY . .
</code></pre><p>So, this is solely a performance/storage optimization - Docker has multiple cached layers and detection of non-changed files. Basically, by only copying the .csproj files before doing <code>dotnet restore</code>, we can exploit the caching of NuGet packages.</p>
<p>The end-result is that at this point in the docker file, all the source code and referenced NuGet packages will be in the <code>/src</code> folder inside the build container.</p>
<h4 id="building-and-testing">Building and testing</h4>
<pre tabindex="0"><code>WORKDIR &#34;/src/Anex.Domain.Tests&#34;
RUN dotnet test &#34;Anex.Domain.Tests.csproj&#34;

WORKDIR &#34;/src/Anex.Api&#34;
RUN dotnet build &#34;Anex.Api.csproj&#34; -c $BUILD_CONFIGURATION -o /app/build

FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish &#34;Anex.Api.csproj&#34; -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT [&#34;dotnet&#34;, &#34;Anex.Api.dll&#34;]
</code></pre><p>So, the rest is fairly self-explanatory. First we run tests - we want it to fail as fast as possible if there are any broken tests. Next we build the API and then publish the resulting binaries into the <code>/app/publish</code> folder. Finally, we take the runtime image and create a new image including the binaries and set the entry point (which will be executed everytime a new container is created from the iamge).</p>
<h2 id="conclusion">Conclusion</h2>
<p>This dockerfile took a lot of tinkering to get right - and also to get it working in my local IDE for debugging - there are a gazzillion ways to get it to work, but I&rsquo;m fairly satisfied with the result.</p>
</div>
    <div class="post__footer">
      

      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Magnus Toftdal
        2024
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></body>
</html>
